{% extends 'base.html' %}

{% block title %}Generate SOP - SOP Generator{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-upload"></i> Upload Video to Generate SOP</h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('generate') }}" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-4">
                        <label for="title" class="form-label">SOP Title *</label>
                        <input type="text" class="form-control" id="title" name="title" required
                               placeholder="e.g., Zipper Repair Procedure">
                    </div>
                    
                    <div class="mb-4">
                        <label for="video" class="form-label">Video File *</label>
                        <div class="upload-area border rounded p-5 text-center" id="uploadArea">
                            <i class="bi bi-cloud-upload display-1 text-muted"></i>
                            <h5 class="mt-3">Drag and drop your video here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" class="form-control d-none" id="video" name="video" 
                                   accept=".mp4,.avi,.mov,.webm,.mkv" required>
                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('video').click()">
                                <i class="bi bi-folder2-open"></i> Browse Files
                            </button>
                        </div>
                        <div id="fileInfo" class="mt-2 d-none">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="bi bi-file-earmark-play me-2"></i>
                                <span id="fileName"></span>
                                <button type="button" class="btn-close ms-auto" onclick="clearFile()"></button>
                            </div>
                        </div>
                        <div class="form-text">Supported formats: MP4, AVI, MOV, WebM, MKV (Max 500MB)</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> What happens next?</h6>
                        <ol class="mb-0 ps-3">
                            <li>Video frames are extracted using FFmpeg (15x faster)</li>
                            <li>Audio is transcribed using Whisper AI</li>
                            <li>Gemini AI analyzes frames and generates step-by-step instructions</li>
                            <li>A professional PDF is created with your company branding: <strong>{{ current_user.company_name }}</strong></li>
                        </ol>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
                        <i class="bi bi-cpu"></i> Generate SOP
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const videoInput = document.getElementById('video');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-primary', 'bg-light');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('border-primary', 'bg-light');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-primary', 'bg-light');
        if (e.dataTransfer.files.length) {
            videoInput.files = e.dataTransfer.files;
            showFileInfo(e.dataTransfer.files[0]);
        }
    });

    videoInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            showFileInfo(e.target.files[0]);
        }
    });

    function showFileInfo(file) {
        fileName.textContent = file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)';
        fileInfo.classList.remove('d-none');
        uploadArea.classList.add('d-none');
    }

    function clearFile() {
        videoInput.value = '';
        fileInfo.classList.add('d-none');
        uploadArea.classList.remove('d-none');
    }

    document.getElementById('uploadForm').addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    });
</script>
{% endblock %}
